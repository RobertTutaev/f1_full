function AnalysisScene(e){function n(){var n=new PIXI.CanvasRenderer(config.canvasWidth,config.canvasHeight,{view:t});document.body.appendChild(n.view),n.render(e)}var t=$(config.canvasAnalysisEl)[0],i=t.getContext("2d");n(),this.analysis=function(e,n){for(var t=i.getImageData(n.position.x,n.position.y,e.get("speedX")+Math.sign(e.get("speedX")+1e-4),e.get("speedY")+Math.sign(e.get("speedY")+1e-4)).data,a=0,s=t.length;a<s;a+=4)t[a]===config.roadEndColor[0]&&t[a+1]===config.roadEndColor[1]&&t[a+2]===config.roadEndColor[2]&&e.stop();return e}}function MainScene(e){function n(e){e<config.stages.length?g.push(new Atlas(config.stages[e].urlXML,config.stages[e].urlIMG,function(){n(e+1)})):g.push(new Atlas(config.cars.urlXML,config.cars.urlIMG,function(){t()}))}function t(){function e(){requestAnimationFrame(e),a(),TWEEN.update(),n.render(t)}var n=new PIXI.CanvasRenderer(config.canvasWidth,config.canvasHeight,{view:$(config.canvasEl)[0]});document.body.appendChild(n.view);var t=i();e()}function i(){function e(e,n){for(var t,i=new PIXI.Container,a=0;a<e.map.length;a++)for(var s=0;s<e.map[a].length;s++)t=new PIXI.Sprite(n.getTexture(e.map[a][s][0])),t.position.x=e.map[a][s][1],t.position.y=e.map[a][s][2],t.rotation=e.map[a][s][3],t.scale.x=e.map[a][s][4],t.scale.y=e.map[a][s][5],i.addChild(t);return i}for(var n=new PIXI.Stage,t=0;t<config.stages.length;t++)n.addChild(e(config.stages[t],g[t])),config.stagesNumber===t&&(s=new AnalysisScene(n));return o=new PIXI.Sprite(g[config.stages.length].getTexture(config.cars.intro.img)),o.position.x=config.cars.intro.beginX,o.position.y=config.cars.intro.beginY,o.rotation=config.cars.intro.imgRotation,o.alpha=0,o.anchor.x=.5,o.anchor.y=.5,l.addChild(o),n.addChild(l),n}function a(){for(var n,t,i,a=0;a<r.length;a++){if(r[a].rotation=e.at(a).get("imgRotation")+e.at(a).get("rotation"),n=s.analysis(e.at(a),r[a]),r[a].position.x=r[a].position.x+n.get("speedX"),r[a].position.y=r[a].position.y+n.get("speedY"),0===e.at(a).get("endTime")){if(config.roadCheckPoints[e.at(a).get("checkPointNumber")][0]<r[a].position.x&&config.roadCheckPoints[e.at(a).get("checkPointNumber")][2]>r[a].position.x&&config.roadCheckPoints[e.at(a).get("checkPointNumber")][1]<r[a].position.y&&config.roadCheckPoints[e.at(a).get("checkPointNumber")][3]>r[a].position.y)if(i=e.at(a).get("checkPointNumber")+1,i>=config.roadCheckPoints.length){e.at(a).set({endTime:Date.now()});var o={n:a,width:r[a].width,height:r[a].height,alpha:1};new TWEEN.Tween(o).to({width:3*o.width,height:3*o.height,alpha:0},500).onUpdate(function(){r[this.n].width=this.width,r[this.n].height=this.height,r[this.n].alpha=this.alpha}).onComplete(function(){if(0===e.countCarsInRace()){var n=e.getFastestCarNumber(),t={n:n,x:c[n].position.x,y:c[n].position.y,width:c[n].width,height:c[n].height,anchorX:0,anchorY:0};new TWEEN.Tween(t).to({x:config.canvasWidth/2,y:config.canvasHeight/2,width:3*t.width,height:3*t.height,anchorX:.5,anchorY:.5},500).onUpdate(function(){c[n].position.x=this.x,c[n].position.y=this.y,c[n].width=this.width,c[n].height=this.height,c[n].anchor.x=this.anchorX,c[n].anchor.y=this.anchorY}).start()}}).start()}else e.at(a).set({checkPointNumber:i});t=Date.now()}else t=e.at(a).get("endTime");c[a].text=e.at(a).get("name")+": "+(t-e.at(a).get("beginTime"))/1e3+"s"}}var s,o,r=[],c=[],g=[],l=new PIXI.Container;n(0),this.beginRace=function(){function n(){var n;e.each(function(e){n=new PIXI.Text("",{font:"40px Arial",fill:"Gold"}),n.position.y=40*c.length,c.push(n),l.addChild(n),e.setDefaults(),n=new PIXI.Sprite(g[config.stages.length].getTexture(e.get("img"))),n.position.x=e.get("beginX"),n.position.y=e.get("beginY"),n.rotation=e.get("imgRotation")+e.get("rotation"),n.alpha=1,n.anchor.x=.5,n.anchor.y=.5,r.push(n),l.addChild(n)})}this.breakRace();var t={x:config.cars.intro.beginX,y:config.cars.intro.beginY,alpha:config.cars.intro.beginAlpha};new TWEEN.Tween(t).to({x:config.cars.intro.endX,y:config.cars.intro.endY,alpha:config.cars.intro.endAlpha},600).onUpdate(function(){o.position.x=this.x,o.position.y=this.y,o.alpha=this.alpha}).onComplete(function(){o.position.x=config.cars.intro.beginX,o.position.y=config.cars.intro.beginY,o.alpha=0,n()}).start()},this.breakRace=function(){for(var e=0;e<r.length;e++)l.removeChild(r[e]),l.removeChild(c[e]);r=[],c=[]}}function Atlas(e,n,t){function i(){var n;window.XMLHttpRequest?n=new XMLHttpRequest:window.ActiveXObject&&(n=new ActiveXObject("Microsoft.XMLHTTP")),n.open("GET",e),n.onload=function(e){if(4==n.readyState&&200==n.status){for(var i=n.responseXML,a=i.getElementsByTagName("SubTexture"),o=0;o<a.length;o++)s[a[o].getAttribute("name")]={x:parseInt(a[o].getAttribute("x")),y:parseInt(a[o].getAttribute("y")),w:parseInt(a[o].getAttribute("width")),h:parseInt(a[o].getAttribute("height"))};t()}},n.send()}var a,s=[];if(void 0===e||""===e||void 0===n||""===n)throw new Error("Some error: {urlXML: "+e+", urlIMG: "+n+"}");a=new PIXI.BaseTexture.fromImage(n),i(),this.getAtlasValues=function(){return s},this.getTexture=function(e){if(void 0!==s[e])return new PIXI.Texture(a,new PIXI.Rectangle(s[e].x,s[e].y,s[e].w,s[e].h));throw new Error("Texture not found: {name: "+e+"}")}}function DB(){var e=openDatabase(config.db.name,config.db.version,config.db.label,config.db.size),n=new Backbone.Collection;n.on("add",function(n){e?e.transaction(function(e){e.executeSql(n.get("checkSQL"),[],null,function(e,t){e.executeSql(n.get("createSQL"),[],null,function(e,n){console.log("Query Error: "+n.message)})})}):console.log(config.db.errorDBConnectMessage)}),n.add(config.db.tables),this.selectValues=function(t,i,a){e.transaction(function(e){e.executeSql(n.findWhere({name:t}).get("selectSQL"),i,a,function(e,n){console.log("Query Error: "+n.message)})})},this.insertValues=function(t,i){e.transaction(function(e){e.executeSql(n.findWhere({name:t}).get("insertSQL"),i,null,function(e,n){console.log("Query Error: "+n.message)})})}}function getMainView(){var e=Backbone.View.extend({el:"#main-control",db:{},collection:{},template:template("main"),events:{"click #btn-play":"play","click #btn-play2":"play2","click #btn-back":"back","click #btn-back2":"back2","click #btn-back3":"back2","click #btn-controls":"controls","click #btn-results":"results"},initialize:function(){this.collection=new СarsCollection,this.scene=new MainScene(this.collection);try{this.db=new DB}catch(e){console.log("DB Error: "+e.message)}_.bindAll(this,"on_keypress"),$(document).bind("keypress",this.on_keypress),this.listenTo(this.collection,"change:endTime",this.onChangeEndTime),this.render()},render:function(e){return this.$el.html(this.template({data:e})),this},play:function(){$(this.$el).find("#main-menu").css({animation:"scale_main_control0 1s forwards"}),$(this.$el).find("#btn-back").css({visibility:"visible"}),$(this.$el).find("#btn-play").trigger("blur"),this.collection.setCarsInRace(1),this.scene.beginRace()},play2:function(){$(this.$el).find("#main-menu").css({animation:"scale_main_control0 1s forwards"}),$(this.$el).find("#btn-back").css({visibility:"visible"}),$(this.$el).find("#btn-play").trigger("blur"),this.collection.setCarsInRace(2),this.scene.beginRace()},back:function(){$(this.$el).find("#main-menu").css({animation:"scale_main_control1 1s forwards"}),$("#btn-back").css({visibility:"hidden"}),$(this.$el).find("#btn-play").trigger("focus"),this.scene.breakRace()},back2:function(){this.template=template("main"),this.render()},controls:function(){function e(){for(var e="",n=0;n<config.cars.items.length;n++){e=e+"<ul> Car: <b>"+config.cars.items[n].name+"</b>";for(key in config.cars.items[n].controlKeys)e=e+'<li><b>"'+key+'"</b> - '+config.cars.items[n].controlKeys[key]+"</li>";e+="</ul>"}return e}this.template=template("controls"),this.render(e())},results:function(){var e=this;try{this.db.selectValues("results",[],function(n,t){for(var i="<table><tr><th>№</th><th>Car</th><th>Time (s)</th><th>Сhronology</th></tr>",a=0;a<t.rows.length;a++)i=i+"<tr><td>"+(a+1)+"</td><td>"+t.rows.item(a).name+"</td><td>"+t.rows.item(a).result+"</td><td>"+t.rows.item(a).date_time+"<td></tr>";i+="</table>",e.template=template("results"),e.render(i)})}catch(e){console.log("DB Error: "+e.message)}},on_keypress:function(e){function n(e){return null==e.which?e.keyCode<32?null:String.fromCharCode(e.keyCode):0!=e.which&&0!=e.charCode?e.which<32?null:String.fromCharCode(e.which):null}var t=n(e),i=this.collection.carsInRace();i.each(function(e){e.controlCar(t)})},onChangeEndTime:function(e){if(0!==e.get("endTime"))try{this.db.insertValues("results",[e.get("name"),(e.get("endTime")-e.get("beginTime"))/1e3])}catch(e){console.log("DB Error: "+e.message)}0===this.collection.countCarsInRace()}});return new e}function getConfig(){return{canvasEl:"#main-canvas",canvasAnalysisEl:"#analysis-canvas",canvasWidth:1016,canvasHeight:762,stagesNumber:0,stages:[{urlXML:"img/racing-pack/Spritesheets/spritesheet_tiles.xml",urlIMG:"img/racing-pack/Spritesheets/spritesheet_tiles.png",map:[[["land_grass11.png",0,0,0,1,1],["land_grass11.png",127,0,0,1,1],["land_grass11.png",254,0,0,1,1],["land_grass01.png",381,0,0,1,1],["land_grass09.png",508,0,0,1,1],["land_grass09.png",635,0,0,1,1],["land_grass09.png",762,0,0,1,1],["land_grass02.png",889,0,0,1,1]],[["land_grass01.png",0,127,0,1,1],["land_grass09.png",127,127,0,1,1],["land_grass09.png",254,127,0,1,1],["land_grass10.png",381,127,0,1,1],["land_grass12.png",508,127,0,1,1],["land_grass13.png",635,127,0,1,1],["land_grass14.png",762,127,0,1,1],["land_grass03.png",889,127,0,1,1]],[["land_grass05.png",0,254,0,1,1],["land_grass12.png",127,254,0,1,1],["land_grass13.png",254,254,0,1,1],["land_grass13.png",381,254,0,1,1],["land_grass07.png",508,254,0,1,1],["land_grass11.png",635,254,0,1,1],["land_grass05.png",762,254,0,1,1],["land_grass03.png",889,254,0,1,1]],[["land_grass05.png",0,381,0,1,1],["land_grass03.png",127,381,0,1,1],["land_grass11.png",254,381,0,1,1],["land_grass01.png",381,381,0,1,1],["land_grass09.png",508,381,0,1,1],["land_grass09.png",635,381,0,1,1],["land_grass10.png",762,381,0,1,1],["land_grass03.png",889,381,0,1,1]],[["land_grass05.png",0,508,0,1,1],["land_grass08.png",127,508,0,1,1],["land_grass09.png",254,508,0,1,1],["land_grass10.png",381,508,0,1,1],["land_grass12.png",508,508,0,1,1],["land_grass13.png",635,508,0,1,1],["land_grass13.png",762,508,0,1,1],["land_grass07.png",889,508,0,1,1]],[["land_grass06.png",0,635,0,1,1],["land_grass13.png",127,635,0,1,1],["land_grass13.png",254,635,0,1,1],["land_grass13.png",381,635,0,1,1],["land_grass07.png",508,635,0,1,1],["land_grass11.png",635,635,0,1,1],["land_grass11.png",762,635,0,1,1],["land_grass11.png",889,635,0,1,1]]]},{urlXML:"img/racing-pack/Spritesheets/spritesheet_objects.xml",urlIMG:"img/racing-pack/Spritesheets/spritesheet_objects.png",map:[[["skidmark_long_2.png",115,425,.1,.5,.5]],[["oil.png",75,500,0,.6,.6],["oil.png",956,380,1.7,.6,.6]],[["rock2.png",130,120,0,1,1],["rock1.png",390,320,0,1,1],["rock3.png",920,0,.1,1,1],["rock2.png",944,34,0,1,1],["rock2.png",50,675,1,1,1]],[["barrier_red_race.png",590,370,-.05,1,1],["barrier_red.png",710,590,-.02,1,1]],[["tent_blue.png",640,225,-.1,1,1]],[["barrel_red_down.png",340,60,.1,1,1],["barrel_red.png",280,60,0,1,1],["barrel_red.png",305,5,0,1,1],["barrel_blue.png",365,7,0,1,1],["barrel_blue_down.png",85,707,.1,1,1],["barrel_blue.png",155,707,0,1,1]],[["tree_small.png",0,50,0,1,1],["tree_small.png",130,5,0,1,1],["tree_small.png",300,420,0,1,1],["tree_small.png",870,623,0,1,1],["tree_small.png",641,559,.7,1,1]],[["tree_large.png",207,314,.1,1,1]],[["arrow_white.png",112,380,0,.2,.2],["arrow_white.png",907,320,-3.14,.2,.2]],[["barrier_white.png",385,705,-1.59,.64,.2]]]}],cars:{urlXML:"img/racing-pack/Spritesheets/spritesheet_vehicles.xml",urlIMG:"img/racing-pack/Spritesheets/spritesheet_vehicles.png",defaultCar:0,items:[{name:"BMW",img:"car_black_small_5.png",imgRotation:1.57,maxSpeed:3,minSpeed:-1,beginX:445,beginY:617,beginRotation:-3.14,controlKeys:{w:"up",s:"down",z:"stop",a:"left",d:"right"}},{name:"KIA",img:"car_red_small_2.png",imgRotation:1.57,maxSpeed:4,minSpeed:-1,beginX:445,beginY:662,beginRotation:-3.14,controlKeys:{o:"up",l:"down",",":"stop",k:"left",";":"right"}}],intro:{img:"car_green_1.png",imgRotation:1.57,beginAlpha:1,beginX:1016,beginY:381,endX:0,endY:381,endAlpha:0}},roadEndColor:[47,192,108],roadCheckPoints:[[50,370,200,412],[407,180,454,330],[818,307,965,353],[616,432,662,585],[360,562,400,710]],db:{name:"carsDB",label:"The best results of the races",version:"0.1",size:5242880,errorDBConnectMessage:"Failed to connect to database",tables:[{name:"results",createSQL:"CREATE TABLE results (id INTEGER primary key autoincrement, name TEXT, result REAL, date_time DATETIME DEFAULT (DATETIME(CURRENT_TIMESTAMP, 'LOCALTIME')))",checkSQL:"SELECT COUNT(*) FROM results",insertSQL:"INSERT INTO results (name, result) values(?, ?)",selectSQL:"SELECT * FROM results ORDER BY result, id DESC LIMIT 10"}]}}}var Car=Backbone.Model.extend({defaults:{name:"carname",img:"car_red_small_2.png",imgRotation:1.57,maxSpeed:5,minSpeed:-1,rotation:0,speed:0,speedX:0,speedY:0,beginX:0,beginY:0,beginRotation:0,beginTime:0,endTime:0,checkPointNumber:0,controlKeys:{w:"up",s:"down",z:"stop",a:"left",d:"right"}},validate:function(e){e.speed>e.maxSpeed||e.speed<e.minSpeed},controlCar:function(e){switch(this.get("controlKeys")[e]){case"up":this.speedUp();break;case"down":this.speedDown();break;case"stop":this.stop();break;case"left":this.moveLeft();break;case"right":this.moveRight()}},calculateSpeedXY:function(){var e=Math.sin(this.get("rotation"))*this.get("speed");this.set({speedX:Math.sign(Math.sin(this.get("rotation")+Math.PI/2)+1e-4)*Math.sign(this.get("speed"))*Math.sqrt(Math.pow(this.get("speed"),2)-Math.pow(e,2)),speedY:e})},speedUp:function(){this.set({speed:this.get("speed")+.3},{validate:!0}),this.calculateSpeedXY()},speedDown:function(){this.set({speed:this.get("speed")-.3},{validate:!0}),this.calculateSpeedXY()},stop:function(){this.set({speed:0}),this.calculateSpeedXY()},setDefaults:function(){this.set({speed:0,rotation:this.get("beginRotation"),checkPointNumber:0,beginTime:Date.now(),endTime:0}),this.calculateSpeedXY()},moveLeft:function(){this.set({rotation:this.get("rotation")-.2*Math.sign(this.get("speed")+1e-4)}),this.calculateSpeedXY()},moveRight:function(){this.set({rotation:this.get("rotation")+.2*Math.sign(this.get("speed")+1e-4)}),this.calculateSpeedXY()}}),СarsCollection=Backbone.Collection.extend({model:Car,carsInRace:function(){return filtered=this.filter(function(e){return 0===e.get("endTime")}),new СarsCollection(filtered)},countCarsInRace:function(){return this.where({endTime:0}).length},getFastestCarNumber:function(){var e,n=-1,t=9999999999999,i=0;return this.each(function(a){e=a.get("endTime"),0!==e&&t>e&&(t=e,n=i),i++}),n},setCarsInRace:function(e){this.reset();for(var n=0;n<e;n++)this.add(config.cars.items[n])}}),app=app||{},config=getConfig(),template=function(e){return _.template($("#"+e).html())};$(function(){app.view=getMainView()});